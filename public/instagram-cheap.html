<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>dcpynet - Instagram</title>

<style>
:root {
  --bg: #000;
  --text: #fff;
  --subtext: #bfbfbf;
  --green: #00c46b;
  --card-bg: #0d0d0d;
  --border: #1a1a1a;
  --radius: 14px;
  font-family: 'Inter', sans-serif;
}

body {
  margin:0;
  background: var(--bg);
  color: var(--text);
}

header {
  text-align:center;
  padding:50px 20px;
  font-size:3rem;
  font-weight:700;
}
header span { color: var(--green); }

.container {
  max-width:600px;
  margin:auto;
  padding:20px;
}

label {
  display:block;
  margin-top:20px;
  font-weight:600;
}

select, input {
  width:100%;
  padding:10px;
  margin-top:5px;
  border-radius:8px;
  border:none;
  font-size:1rem;
}

button {
  margin-top:20px;
  padding:15px;
  width:100%;
  border:none;
  border-radius:8px;
  background:var(--green);
  color:#000;
  font-weight:700;
  cursor:pointer;
  font-size:1rem;
}

#total {
  margin-top:10px;
  font-weight:600;
  color: var(--green);
}

#balanceBox {
  position: fixed;
  top: 15px;
  right: 20px;
  background: #111;
  padding: 10px 18px;
  border-radius: 10px;
  border: 1px solid #333;
  color: var(--green);
  font-weight: bold;
}
</style>
</head>

<body>

<header><span>dcpynet</span> Instagram</header>

<div id="balanceBox"></div>

<div class="container">

  <label>Category</label>
  <select id="category">
    <option value="followers">Followers</option>
    <option value="likes">Likes</option>
    <option value="comments">Comments</option>
  </select>

  <label>Quality</label>
  <select id="quality"></select>

  <label>Refill</label>
  <select id="refill"></select>

  <label>Quantity</label>
  <input type="number" id="quantity" min="10" value="100">

  <label>Link</label>
  <input type="text" id="link" placeholder="Paste post/profile link">

  <div id="total">Total: $0.00</div>

  <button id="orderBtn">Place Order</button>

</div>

<script>
/* ðŸ”’ LOGIN REQUIRED */
const user = JSON.parse(localStorage.getItem("user"));

if (!user) {
  window.location.href = "/login.html";
} else {
  document.getElementById("balanceBox").innerText =
    "Balance: $" + user.balance;
}

/* === SERVICE DATA === */
const services = {
  followers: [
    {id:8950, name:"HQ Profiles", refill:"No Refill", price:1.21},
    {id:8959, name:"Real & Old +7â€“15 Posts", refill:"No Refill", price:1.33},
    {id:8960, name:"Real & Old +7â€“15 Posts", refill:"30 Days", price:1.55},
    {id:8933, name:"HQ Accounts", refill:"No Refill", price:1.31}
  ],

  likes: [
    {id:8923, name:"HQ Profiles", refill:"No Refill", price:1.08},
    {id:8917, name:"Profile Photos", refill:"No Refill", price:1.10}
  ],

  comments: [
    {id:8901, name:"Random Comments", refill:"No Refill", price:1.45},
    {id:8904, name:"Custom Comments", refill:"No Refill", price:1.52}
  ]
};

/* === DROPDOWNS === */
const categoryEl = document.getElementById("category");
const qualityEl = document.getElementById("quality");
const refillEl = document.getElementById("refill");
const quantityEl = document.getElementById("quantity");
const totalEl = document.getElementById("total");

function updateDropdowns() {
  const cat = categoryEl.value;
  const catServices = services[cat];

  const qualities = [...new Set(catServices.map(s => s.name))];
  qualityEl.innerHTML = qualities.map(q =>
    `<option value="${q}">${q}</option>`
  ).join("");

  updateRefill();
}

function updateRefill() {
  const cat = categoryEl.value;
  const qual = qualityEl.value;

  const filtered = services[cat].filter(s => s.name === qual);
  const refills = [...new Set(filtered.map(s => s.refill))];

  refillEl.innerHTML = refills.map(r =>
    `<option value="${r}">${r}</option>`
  ).join("");

  updateTotal();
}

function getService() {
  const cat = categoryEl.value;
  const qual = qualityEl.value;
  const refill = refillEl.value;

  return services[cat].find(
    s => s.name === qual && s.refill === refill
  );
}

function updateTotal() {
  const service = getService();
  const qty = parseInt(quantityEl.value) || 0;

  const total = service
    ? (service.price * (qty / 1000)).toFixed(2)
    : "0.00";

  totalEl.textContent = `Total: $${total}`;
  return total;
}

/* EVENTS */
categoryEl.addEventListener("change", updateDropdowns);
qualityEl.addEventListener("change", updateRefill);
refillEl.addEventListener("change", updateTotal);
quantityEl.addEventListener("input", updateTotal);

updateDropdowns();

/* === PLACE ORDER + BALANCE DEDUCTION === */
document.getElementById("orderBtn").addEventListener("click", async () => {
  const service = getService();
  const link = document.getElementById("link").value;
  const quantity = parseInt(quantityEl.value);

  const totalPrice = parseFloat(updateTotal());

  if (!service || !link || !quantity) {
    return alert("Missing info");
  }

  if (user.balance < totalPrice) {
    return alert("Not enough balance!");
  }

  const res = await fetch("/api/order", {
    method: "POST",
    headers: { "Content-Type": "application/json" },

    body: JSON.stringify({
      email: user.email,
      service: service.id,
      link,
      quantity,
      price: totalPrice
    })
  });

  const data = await res.json();

  if (data.error) {
    alert("Error: " + data.error);
    return;
  }

  /* UPDATE BALANCE */
  user.balance = data.newBalance;
  localStorage.setItem("user", JSON.stringify(user));

  document.getElementById("balanceBox").innerText =
    "Balance: $" + user.balance;

  alert("Order placed successfully! New Balance: $" + user.balance);
});
</script>

</body>
</html>
